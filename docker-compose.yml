# SPDX-FileCopyrightText: 2025 The superseedr Contributors
# SPDX-License-Identifier: GPL-3.0-or-later

services:
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      # Volume for Gluetun's internal data
      - gluetun-data:/gluetun
      # Shared volume to write the port file
      - forwarded-port:/tmp/gluetun
    env_file:
      - .gluetun.env
    environment:
      # If CLIENT_PORT is set in .env, this passes it to Gluetun.
      # If CLIENT_PORT is NOT set, this will be empty, which is
      # correct for users with dynamic port forwarding.
      - FIREWALL_VPN_INPUT_PORTS=${CLIENT_PORT}     
    restart: unless-stopped

  superseedr:
    extends:
      file: docker-compose.common.yml
      service: superseedr
    # This attaches superseedr to gluetun's network
    network_mode: "service:gluetun"
    depends_on: [gluetun]
    volumes:
      # --- App Volumes (from common.yml) ---
      - ${HOST_SUPERSEEDR_DATA_PATH:-superseedr-data}:/superseedr-data
      - ${HOST_SUPERSEEDR_CONFIG_PATH:-superseedr-config}:/root/.config/jagalite.superseedr
      - ${HOST_SUPERSEEDR_SHARE_PATH:-superseedr-share}:/root/.local/share/jagalite.superseedr
      
      # --- Shared Port Volume ---
      # This is where superseedr reads the port file
      - forwarded-port:/port-data

  # --- Plugins ---

  superseedr-rss:
    build: ./plugins/RSS/superseedr-rss
    container_name: superseedr-rss
    ports:
      - "3000:3000"
    volumes:
      - ${HOST_SUPERSEEDR_SHARE_PATH:-superseedr-share}:/superseedr-watch
      - ${HOST_SUPERSEEDR_DATA_PATH:-superseedr-data}:/superseedr-status
      - rss-data:/data
    environment:
      - WATCH_DIR=/superseedr-watch/watch_files
      - STATUS_DIR=/superseedr-status/status_files
      - DATA_DIR=/data
      - PORT=3000
    restart: unless-stopped

  superseedr-notifications:
    build: ./plugins/Notifications/superseedr-notifications
    container_name: superseedr-notifications
    ports:
      - "5000:5000"
    volumes:
      - ${HOST_SUPERSEEDR_DATA_PATH:-superseedr-data}:/data/status_files:ro
      - notifications-data:/data
    environment:
      - STATUS_FILE=/data/status_files/app_state.json
      - DATA_DIR=/data
    restart: unless-stopped

  superseedr-webui-backend:
    build: ./plugins/WebUI/superseedr-webui/backend
    container_name: superseedr-webui-backend
    ports:
      - "8082:8080"
    volumes:
      - ${HOST_SUPERSEEDR_DATA_PATH:-superseedr-data}:/superseedr-data:ro
    environment:
      - STATUS_FILE=/superseedr-data/status_files/app_state.json
      - PORT=8080
    restart: unless-stopped

  superseedr-webui-frontend:
    build: 
      context: ./plugins/WebUI/superseedr-webui/frontend
      args:
        - VITE_API_URL=http://localhost:8082/api/stats
    container_name: superseedr-webui-frontend
    ports:
      - "3001:80"
    restart: unless-stopped

# Define all the volumes used
volumes:
  superseedr-data:
  superseedr-config:
  superseedr-share:
  gluetun-data:
  forwarded-port:
  rss-data:
  notifications-data:
